<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formular Articol</title>
    <link rel="icon" type="image/png" href="images/logo_intro.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <header>
        <h1>
            <img src="images/logo_intro.png" alt="Logo" class="header-logo">
            Evidență Echipamente IT
        </h1>
    </header>

    <main class="container">

        <div class="page-actions">
            <h2 id="form-title">Încărcare...</h2>
            <button class="btn btn-cancel" style="background-color: var(--secondary-color);">
                <i class="fa-solid fa-arrow-left"></i> Înapoi
            </button>
        </div>

        <div class="form-container" id="form-echipament-container" style="display: none;">
            <form id="form-echipament">
                <input type="hidden" name="CATEGORIE" value="Echipament IT">
                <h3><i class="fa-solid fa-laptop-code"></i> Date Echipament IT</h3>

                <div class="detalii-grid">
                    <div class="form-group"><label>Nr. Inventar</label><input type="text" name="NR_INVENTAR" required></div>
                    <div class="form-group"><label>Tip Echipament</label><input type="text" name="TIP_CALC"></div>
                    <div class="form-group"><label>Nume PC</label><input type="text" name="NUME_PC"></div>
                    <div class="form-group"><label>Utilizator</label><input type="text" name="UTILIZATOR"></div>
                    <div class="form-group"><label>Nr. User</label><input type="text" name="NR_USER"></div>
                    <div class="form-group"><label>Data Achiziție</label><input type="date" name="DATA_ACHIZITIE"></div>
                    <div class="form-group"><label>Etaj</label><input type="text" name="ETAJ"></div>
                    <div class="form-group"><label>Funcție</label><input type="text" name="FUNCTIE"></div>
                    <div class="form-group"><label>Adresă IP</label><input type="text" name="IP"></div>
                    <div class="form-group"><label>Retea</label><input type="text" name="RETEA"></div>
                    <div class="form-group"><label>Serie UC</label><input type="text" name="SERIE_UC"></div>
                    <div class="form-group"><label>Serie Monitor</label><input type="text" name="SERIE_MON"></div>
                    <div class="form-group"><label>Memorie</label><input type="text" name="MEMORIE"></div>
                    <div class="form-group"><label>Sistem Operare</label><input type="text" name="SISTEM_OPERARE"></div>
                    <div class="form-group"><label>Licență SO</label><input type="text" name="LICENTA_SO"></div>
                    <div class="form-group"><label>Office</label><input type="text" name="OFFICE"></div>
                    <div class="form-group"><label>Licență Office</label><input type="text" name="LICENTA_OFFICE"></div>
                    <div class="form-group"><label>Antivirus</label><input type="text" name="ANTIVIRUS"></div>
                    <div class="form-group"><label>Cameră</label><input type="text" name="CAMERA"></div>
                    <div class="form-group"><label>Telefon</label><input type="text" name="TELEFON"></div>
                    <div class="form-group"><label>Parchet</label><input type="text" name="PARCHET"></div>
                    <div class="form-group"><label>Pass</label><input type="text" name="PASS"></div>
                </div>
                <div class="form-group"><label>Periferice Atasate</label><textarea name="PERIFERICE" rows="3"></textarea></div>
                <div class="form-group"><label>Observații</label><textarea name="OBS" rows="3"></textarea></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" style="background-color: var(--secondary-color);">Anulează</button>
                    <button type="submit" class="btn btn-submit"><i class="fa-solid fa-save"></i> Salvează</button>
                </div>
            </form>
        </div>

        <div class="form-container" id="form-periferic-container" style="display: none;">
            <form id="form-periferic">
                <input type="hidden" name="CATEGORIE" value="Periferic">
                <h3><i class="fa-solid fa-print"></i> Date Periferic</h3>

                <div class="detalii-grid">
                    <div class="form-group"><label>Nr. Inventar</label><input type="text" name="NR_INVENTAR" required></div>
                    <div class="form-group"><label>Tip</label><input type="text" name="TIP"></div>
                    <div class="form-group"><label>Producător</label><input type="text" name="PRODUCATOR"></div>
                    <div class="form-group"><label>Nume Periferic</label><input type="text" name="NUME_PERIFERICE"></div>
                    <div class="form-group"><label>Utilizator</label><input type="text" name="UTILIZATOR"></div>
                    <div class="form-group"><label>Nume User</label><input type="text" name="NUME_USER"></div>
                    <div class="form-group"><label>Data Achiziție</label><input type="date" name="DATA_ACHIZITIE"></div>
                    <div class="form-group"><label>Conectat la PC</label><input type="text" name="NUME_CALC"></div>
                    <div class="form-group"><label>Serie UC</label><input type="text" name="SERIE_UC"></div>
                    <div class="form-group"><label>IP</label><input type="text" name="IP"></div>
                    <div class="form-group"><label>Retea</label><input type="text" name="RETEA"></div>
                    <div class="form-group"><label>Memorie</label><input type="text" name="MEMORIE"></div>
                    <div class="form-group"><label>Format</label><input type="text" name="FORMAT"></div>
                    <div class="form-group"><label>Culoare</label><input type="text" name="CULOARE_IMPRIMARE"></div>
                    <div class="form-group"><label>Duplex</label><input type="text" name="DUPLEX"></div>
                    <div class="form-group"><label>Stare</label><input type="text" name="STARE_PARAMETRI"></div>
                    <div class="form-group"><label>Cameră</label><input type="text" name="CAMERA"></div>
                    <div class="form-group"><label>Antivirus</label><input type="text" name="ANTIVIRUS"></div>
                    <div class="form-group"><label>Parchet</label><input type="text" name="PARCHET"></div>
                    <div class="form-group"><label>Pass</label><input type="text" name="PASS"></div>
                </div>
                <div class="form-group"><label>Observații</label><textarea name="OBS" rows="3"></textarea></div>
                <div class="form-group"><label>Observații 2</label><textarea name="OBS2" rows="3"></textarea></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" style="background-color: var(--secondary-color);">Anulează</button>
                    <button type="submit" class="btn btn-submit"><i class="fa-solid fa-save"></i> Salvează</button>
                </div>
            </form>
        </div>
    </main>

    <footer class="app-footer">
        <p>© 2025 Aplicație Internă IT</p>
    </footer>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';
        let editMode = false;
        let originalId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type');
            const id = params.get('id');

            const formTitle = document.getElementById('form-title');
            const formEchipament = document.getElementById('form-echipament-container');
            const formPeriferic = document.getElementById('form-periferic-container');

            if (!type) {
                window.location.href = 'select_type.html';
                return;
            }

            if (id) {
                editMode = true;
                originalId = id;
                formTitle.innerHTML = `<i class="fa-solid fa-pencil"></i> Editare ${type === 'echipament' ? 'Echipament' : 'Periferic'}`;
                document.querySelectorAll('.btn-submit').forEach(btn => btn.innerHTML = '<i class="fa-solid fa-save"></i> Actualizează');
                incarcaDate(id, type);
            } else {
                formTitle.innerHTML = `<i class="fa-solid fa-plus-circle"></i> Adăugare ${type === 'echipament' ? 'Echipament' : 'Periferic'}`;
            }

            if (type === 'echipament') {
                formEchipament.style.display = 'block';
            } else {
                formPeriferic.style.display = 'block';
            }

            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    window.history.back();
                });
            });

            document.getElementById('form-echipament').addEventListener('submit', function(e) {
                e.preventDefault();
                salveazaDate(this, 'echipamente', type);
            });

            document.getElementById('form-periferic').addEventListener('submit', function(e) {
                e.preventDefault();
                salveazaDate(this, 'periferice', type);
            });
        });

        function incarcaDate(id, type) {
            const endpoint = type === 'echipament' ? 'echipament' : 'periferic';

            fetch(`${API_BASE}/${endpoint}/${id}`)
                .then(res => res.json())
                .then(data => {
                    if(data.eroare) {
                        alert("Eroare la încărcarea datelor: " + data.eroare);
                        return;
                    }

                    for (const [key, value] of Object.entries(data)) {
                        const form = type === 'echipament'
                            ? document.getElementById('form-echipament')
                            : document.getElementById('form-periferic');

                        const input = form.querySelector(`[name="${key}"]`);

                        if (input) {
                            if (input.type === 'date' && value) {
                                try {
                                    let dateVal = new Date(value);
                                    const offset = dateVal.getTimezoneOffset();
                                    dateVal = new Date(dateVal.getTime() - (offset*60*1000));
                                    input.value = dateVal.toISOString().split('T')[0];
                                } catch (e) {
                                    input.value = value;
                                }
                            } else {
                                input.value = (value !== null && value !== 'None') ? value : '';
                            }
                        }
                    }
                })
                .catch(err => console.error(err));
        }

        function salveazaDate(form, endpointCategory, type) {
            const formData = new FormData(form);
            const dataObj = Object.fromEntries(formData.entries());

            let url, method;

            if (editMode) {
                url = `${API_BASE}/${endpointCategory}/update/${originalId}`;
                method = 'PUT';
            } else {
                url = `${API_BASE}/${endpointCategory}/add`;
                method = 'POST';
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataObj)
            })
            .then(res => res.json())
            .then(response => {
                if (response.succes) {
                    alert(response.mesaj || 'Operațiune reușită!');
                    if (editMode) {
                        window.location.href = `detalii.html?id=${dataObj.NR_INVENTAR}&type=${type}`;
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    alert('Eroare: ' + (response.eroare || 'Necunoscută'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Eroare de rețea. Verifică consola.');
            });
        }
    </script>

</body>
</html>