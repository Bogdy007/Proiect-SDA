<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventar IT - Parchetul Brașov</title>
    <link rel="icon" type="image/png" href="images/logo_intro.png">

    <style>html { opacity: 0; transition: opacity 0.5s ease-in-out; }</style>

    <script>
        // Forțează reîncărcarea dacă userul dă BACK (pentru a nu lua pagina din cache)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                window.location.reload();
            }
        });
    </script>

    <link rel="stylesheet" href="style.css?v=4">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <header>
        <h1>
            <img src="images/logo_intro.png" alt="Logo" class="header-logo">
            Evidență Echipamente IT
        </h1>
        <div id="controls" style="display:flex; gap:10px; align-items: center;"></div>
    </header>

    <main class="container">

        <div class="page-actions">
            <h2><i class="fa-solid fa-list-ul"></i> Echipamente și Periferice</h2>
            <a href="select_type.html" class="btn btn-adauga" id="btn-add" style="display:none;"><i class="fa-solid fa-plus"></i> Adaugă Articol Nou</a>
        </div>

        <section class="filtre">
            <h3><i class="fa-solid fa-filter"></i> Filtre Căutare</h3>

            <div class="search-row">
                <div class="input-with-icon">
                    <i class="fa-solid fa-hashtag"></i>
                    <input type="text" id="filtru-inventar" placeholder="Nr. Inventar...">
                </div>

                <div class="input-with-icon">
                    <i class="fa-solid fa-user"></i>
                    <input type="text" id="filtru-utilizator" placeholder="Utilizator...">
                </div>

                <div class="input-with-icon">
                    <i class="fa-solid fa-building"></i>
                    <input type="text" id="filtru-locatie" placeholder="Etaj (ex: 1, 2, Parter)...">
                </div>

                <button id="btn-cauta" class="btn"><i class="fa-solid fa-search"></i> Caută</button>
            </div>

            <div style="width: 100%; text-align: right; margin-top: 10px;">
                <a href="#" id="toggle-avansat" style="font-size: 0.9em; color: var(--primary-color); text-decoration: none;">
                    <i class="fa-solid fa-sliders"></i> Căutare Avansată
                </a>
            </div>

            <div id="zona-avansata" class="search-row" style="display: none; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
                <div class="input-with-icon">
                    <i class="fa-solid fa-desktop"></i>
                    <input type="text" id="filtru-nume" placeholder="Nume PC / Periferic...">
                </div>
                <div class="input-with-icon">
                    <i class="fa-solid fa-barcode"></i>
                    <input type="text" id="filtru-serie" placeholder="Serie (S/N)...">
                </div>
                <div class="input-with-icon">
                    <i class="fa-solid fa-network-wired"></i>
                    <input type="text" id="filtru-ip" placeholder="Adresă IP...">
                </div>
                <div class="input-with-icon">
                    <i class="fa-solid fa-laptop"></i>
                    <input type="text" id="filtru-tip" placeholder="Tip (ex: Laptop, Imprimantă)...">
                </div>
            </div>
        </section>

        <section class="lista-echipamente">
            <table id="tabel-echipamente">
                <thead>
                    <tr>
                        <th style="width: 8%;">Nr. Inv</th>
                        <th style="width: 12%;">Tip</th>
                        <th style="width: 18%;">Nume PC / Periferic</th>
                        <th style="width: 12%;">S/N (Serie)</th>
                        <th style="width: 12%;">Adresă IP</th>
                        <th style="width: 8%;">Etaj</th>
                        <th style="width: 15%;">Utilizator</th>
                        <th style="width: 15%;">Acțiuni</th>
                    </tr>
                </thead>
                <tbody id="tabel-body">
                </tbody>
            </table>
        </section>
    </main>

    <footer class="app-footer">
        <p>© 2026 Parchetul de pe lângă Tribunalul Brașov. Toate drepturile rezervate.</p>
    </footer>

    <script>
        // FOLOSIM CALEA RELATIVA ACUM
        const API_GET_ALL = '/api/assets/all';

        async function init() {
            // 1. VERIFICARE LOGIN
            const res = await fetch('/api/me');
            const u = await res.json();

            // Dacă nu e logat, redirect și STOP (nu mai afișăm pagina)
            if(!u.logged_in) {
                window.location.href = 'login.html';
                return;
            }

            // 2. AFISARE BUTOANE ADMIN (Dacă am ajuns aici, userul e logat)
            const c = document.getElementById('controls');
            if (u.role === 'admin') {
                c.innerHTML += `<a href="admin_users.html" class="btn" style="background:#ffc107; color:black; margin-right:10px;">Admin</a>`;
                document.getElementById('btn-add').style.display = 'inline-flex';
            }
            c.innerHTML += `<button onclick="logout()" class="btn btn-danger">Logout</button>`;

            // 3. INCARCARE INITIALA A TABELULUI
            incarcaEchipamente(API_GET_ALL);

            // 4. PREZENTARE PAGINA (CODUL TĂU)
            // AICI ESTE CHEIA: Dăm drumul la lumină DOAR ACUM, după ce știm că userul e logat
            requestAnimationFrame(() => {
                document.documentElement.style.opacity = '1';
                document.body.classList.add('loaded');
            });
        }

        async function logout() {
            await fetch('/api/logout', {method:'POST'});
            window.location.reload();
        }

        document.getElementById('toggle-avansat').addEventListener('click', (e) => {
            e.preventDefault();
            const zona = document.getElementById('zona-avansata');
            if (zona.style.display === 'none') {
                zona.style.display = 'flex';
                e.target.innerHTML = '<i class="fa-solid fa-minus"></i> Ascunde Căutare Avansată';
            } else {
                zona.style.display = 'none';
                e.target.innerHTML = '<i class="fa-solid fa-sliders"></i> Căutare Avansată';
                document.getElementById('filtru-nume').value = '';
                document.getElementById('filtru-serie').value = '';
                document.getElementById('filtru-ip').value = '';
                document.getElementById('filtru-tip').value = '';
            }
        });

        function incarcaEchipamente(url) {
            const tabelBody = document.getElementById('tabel-body');
            tabelBody.innerHTML = '<tr><td colspan="8" style="text-align:center"><i class="fa-solid fa-spinner fa-spin"></i> Se încarcă...</td></tr>';

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Eroare rețea');
                    return response.json();
                })
                .then(data => {
                    tabelBody.innerHTML = '';
                    if (!data || data.length === 0) {
                        tabelBody.innerHTML = '<tr><td colspan="8" style="text-align:center">Nu au fost găsite articole conform criteriilor.</td></tr>';
                        return;
                    }

                    data.forEach(item => {
                        const tr = document.createElement('tr');

                        // AM ȘTERS: tr.style.cursor = 'pointer'; (Nu mai arată mânuța pe tot rândul)

                        let tipArticol = 'echipament';
                        if (item.CATEGORIE && item.CATEGORIE.toLowerCase().includes('periferic')) {
                            tipArticol = 'periferic';
                        }

                        // AM ȘTERS: tr.addEventListener('click', ...) (Nu mai face nimic click-ul pe rând)

                        // AM MUTAT: Acțiunea de click este acum strict pe butonul "Detalii"
                        // Folosim onclick="..." direct pe buton
                        tr.innerHTML = `
                            <td><strong>${item.NR_INVENTAR}</strong></td>
                            <td>${item.TIP || '-'}</td>
                            <td>${item.NUME || '-'}</td>
                            <td><span style="font-family: monospace; font-size: 0.9em;">${item.SERIE || '-'}</span></td>
                            <td>${item.IP || '-'}</td>
                            <td>${item.ETAJ || ''}</td>
                            <td>${item.UTILIZATOR || '-'}</td>
                            <td>
                                <button
                                    class="btn"
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: var(--primary-color);"
                                    onclick="window.location.href='detalii.html?id=${item.NR_INVENTAR}&type=${tipArticol}'">
                                    Detalii
                                </button>
                            </td>
                        `;
                        tabelBody.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error(error);
                    tabelBody.innerHTML = '<tr><td colspan="8" style="color: red; text-align: center;">Eroare la conectarea cu serverul API.</td></tr>';
                });
        }
        function performSearch() {
            const params = new URLSearchParams();
            const mapping = {
                'nr_inventar': 'filtru-inventar', 'utilizator': 'filtru-utilizator', 'etaj': 'filtru-locatie',
                'nume': 'filtru-nume', 'serie': 'filtru-serie', 'ip': 'filtru-ip', 'tip': 'filtru-tip'
            };
            for (const [key, elementId] of Object.entries(mapping)) {
                const val = document.getElementById(elementId).value.trim();
                if (val) params.append(key, val);
            }
            const url = `${API_GET_ALL}?${params.toString()}`;
            incarcaEchipamente(url);
        }

        document.addEventListener('DOMContentLoaded', () => {
            init(); // AICI INCEPE TOTUL

            document.getElementById('btn-cauta').addEventListener('click', performSearch);
            document.querySelectorAll('.filtre input').forEach(el => {
                el.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            });
        });
    </script>

</body>
</html>