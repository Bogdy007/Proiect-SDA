<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalii Articol</title>
    <link rel="icon" type="image/png" href="images/logo_intro.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .table-scroll-container {
            overflow-x: auto;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        #istoric-interventii table {
            min-width: 1000px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-icon {
            padding: 5px 8px;
            font-size: 0.8rem;
        }
        .admin-only {
            display: none;
        }
    </style>
</head>
<body>

    <header>
        <h1>
            <img src="images/logo_intro.png" alt="Logo" class="header-logo">
            Evidență Echipamente IT
        </h1>
        <div id="user-controls"></div>
    </header>

    <main class="container">

        <div class="page-actions">
             <h2 id="titlu-echipament">Se încarcă datele...</h2>
             <a href="index.html" class="btn" style="background-color: var(--secondary-color);"><i class="fa-solid fa-arrow-left"></i> Înapoi la listă</a>
        </div>

        <div class="actions">
            <button id="btn-genereaza-pdf" class="btn"><i class="fa-solid fa-file-pdf"></i> Generează Fișă (PDF)</button>
            <button id="btn-editeaza" class="btn admin-only" style="background-color: #ffc107; color: #000 !important;"><i class="fa-solid fa-pencil"></i> Editează Articol</button>
            <button id="btn-sterge" class="btn btn-danger admin-only"><i class="fa-solid fa-trash-can"></i> Șterge Articol</button>
        </div>

        <section class="detalii-echipament">
            <h3><i class="fa-solid fa-circle-info"></i> Date Articol</h3>
            <div class="detalii-grid" id="info-articol">
            </div>
        </section>

        <div class="page-actions" style="margin-top: 40px;">
            <h2><i class="fa-solid fa-screwdriver-wrench"></i> Istoric Intervenții</h2>
            <button id="btn-adauga-interventie" class="btn btn-adauga admin-only"><i class="fa-solid fa-plus"></i> Adaugă Intervenție</button>
        </div>

        <section id="istoric-interventii">
            <div class="table-scroll-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nr. Inv</th>
                            <th>Tip Echip.</th>
                            <th>Data</th>
                            <th>Tip Int.</th>
                            <th>Operație</th>
                            <th>Descriere</th>
                            <th>Componente</th>
                            <th>Durată</th>
                            <th>Operator</th>
                            <th>Observații</th>
                            <th>Acțiuni</th>
                        </tr>
                    </thead>
                    <tbody id="interventii-body">
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-interventie" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Adaugă Intervenție Nouă</h2>
                <span class="close-button" id="close-modal-btn">&times;</span>
            </div>

            <form id="form-interventie">
                <input type="hidden" id="edit-interventie-id" value="">

                <div class="detalii-grid">
                    <div class="form-group">
                        <label>Nr. Inventar</label>
                        <input type="text" id="modal-nr-inventar" name="NR_INVENTAR" required>
                    </div>

                    <div class="form-group">
                        <label>Data Intervenție</label>
                        <input type="date" name="DATA_INTERVENTIE" required>
                    </div>
                    <div class="form-group">
                        <label>Tip Intervenție (Software/Hardware)</label>
                        <input type="text" name="TIP_INTERVENTIE" list="list-tipuri">
                        <datalist id="list-tipuri">
                            <option value="Hardware">
                            <option value="Software">
                            <option value="Mentenanță">
                            <option value="Instalare">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label>Tip Operație (ex: Înlocuire)</label>
                        <input type="text" name="TIP_OPERATIE">
                    </div>
                    <div class="form-group">
                        <label>Operator</label>
                        <input type="text" name="OPERATOR" required>
                    </div>
                    <div class="form-group">
                        <label>Durata</label>
                        <input type="text" name="DURATA_INTERVENTIE" placeholder="ex: 30 min">
                    </div>
                </div>

                <div class="form-group">
                    <label>Descriere Detaliată</label>
                    <textarea name="DESCRIERE_INTERVENTIE" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Componente Schimbate / Adăugate</label>
                    <textarea name="componente_schimbate_adaugate" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Observații</label>
                    <textarea name="OBSERVATII" rows="2"></textarea>
                </div>

                <input type="hidden" id="modal-tip-echip" name="TIP_ECHIPAMENT">

                <div class="form-actions">
                    <button type="button" class="btn" id="cancel-modal-btn" style="background-color: #6c757d;">Anulează</button>
                    <button type="submit" class="btn" id="submit-modal-btn">Salvează</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="app-footer">
        <p>© 2026 Parchetul de pe lângă Tribunalul Brașov. Toate drepturile rezervate.</p>
    </footer>

    <script>
        const API_BASE = '/api';
        let nrInventarGlobal = null;
        let tipArticolGlobal = null;
        let interventiiGlobal = [];
        let isAdmin = false;

        const fieldsOrdered = [
            'NR_INVENTAR', 'CATEGORIE', 'TIP_CALC', 'NUME_PC', 'UTILIZATOR',
            'NR_USER', 'DATA_ACHIZITIE', 'ETAJ', 'FUNCTIE', 'IP',
            'RETEA', 'SERIE_UC', 'SERIE_MON', 'MEMORIE', 'SISTEM_OPERARE',
            'LICENTA_SO', 'OFFICE', 'LICENTA_OFFICE', 'ANTIVIRUS', 'CAMERA',
            'TELEFON', 'PERIFERICE', 'PARCHET', 'PASS', 'OBS'
        ];

        // --- FUNCȚIE FORMATARE DATĂ (NOUĂ) ---
        function formateazaData(text) {
            if (!text || text === 'None' || text === '-' || text === 'null') return '-';
            try {
                // Încercăm să facem un obiect Date
                const date = new Date(text);
                if (isNaN(date.getTime())) return text; // Dacă nu e dată validă, returnăm textul original

                // Extragem componentele
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Lunile sunt 0-11
                const year = date.getFullYear();

                return `${day}.${month}.${year}`; // Format ZI.LUNA.AN
            } catch (e) {
                return text;
            }
        }

        function createDetailField(label, value) {
            const valStr = (value && value !== 'None' && value !== 'null') ? value : '-';
            return `<p><strong>${label}</strong> <span>${valStr}</span></p>`;
        }

        async function checkUser() {
            try {
                const res = await fetch('/api/me');
                const user = await res.json();
                if (!user.logged_in) { window.location.href = 'login.html'; return; }
                if (user.role === 'admin') {
                    isAdmin = true;
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
                }
            } catch (e) { console.error("Eroare verificare user:", e); }
        }

        function incarcaDetaliiArticol(nrInventar, tip) {
            let url = (tip === 'echipament') ? `${API_BASE}/echipament/${encodeURIComponent(nrInventar)}` : `${API_BASE}/periferic/${encodeURIComponent(nrInventar)}`;

            fetch(url)
                .then(response => response.json())
                .then(item => {
                    if (!item || item.eroare) {
                        document.getElementById('titlu-echipament').textContent = `Eroare: Articolul nu a fost găsit.`;
                        return;
                    }

                    document.getElementById('titlu-echipament').innerHTML =
                        `<i class="fa-solid fa-barcode"></i> ${item.NR_INVENTAR} <small style="font-size:0.6em; color:#666;">(${item.CATEGORIE})</small>`;

                    const container = document.getElementById('info-articol');
                    container.innerHTML = '';

                    // Funcție ajutătoare pentru afișare
                    const displayField = (key, customLabel = null) => {
                        let label = customLabel || key.replace(/_/g, ' ');
                        label = label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();

                        // Etichete personalizate
                        if(key === 'NR_INVENTAR') label = 'Nr. Inventar';
                        if(key === 'TIP_CALC') label = 'Tip Calc';
                        if(key === 'NUME_PC') label = 'Nume PC';
                        if(key === 'NR_USER') label = 'Nr. User';
                        if(key === 'SERIE_UC') label = 'Serie UC';
                        if(key === 'SERIE_MON') label = 'Serie Monitor';
                        if(key === 'LICENTA_SO') label = 'Licență SO';
                        if(key === 'LICENTA_OFFICE') label = 'Licență Office';
                        if(key === 'DATA_ACHIZITIE') label = 'Data Achiziție';

                        let val = item[key];

                        // --- AICI APLICĂM FORMATAREA DATEI ---
                        if (key.includes('DATA')) {
                            val = formateazaData(val);
                        }

                        container.innerHTML += createDetailField(label, val);
                    };

                    if (tip === 'echipament') {
                        fieldsOrdered.forEach(key => displayField(key));
                    } else {
                        // Periferice - afișăm tot ce vine
                        for (const [key, val] of Object.entries(item)) {
                            if(['id', 'ID'].includes(key)) continue; // Sărim peste ID-ul intern
                            displayField(key);
                        }
                    }
                })
                .catch(error => {
                    console.error('Eroare detalii:', error);
                    document.getElementById('info-articol').innerHTML = '<p style="color:red">Eroare la conectarea cu serverul.</p>';
                });
        }

        function incarcaInterventii(nrInventar) {
            const tabelBody = document.getElementById('interventii-body');
            tabelBody.innerHTML = '<tr><td colspan="12">Se încarcă istoricul...</td></tr>';

            fetch(`${API_BASE}/interventii/${encodeURIComponent(nrInventar)}`)
                .then(response => response.json())
                .then(data => {
                    tabelBody.innerHTML = '';

                    if (data.eroare) {
                         tabelBody.innerHTML = `<tr><td colspan="12" style="color:red">Eroare: ${data.eroare}</td></tr>`;
                         return;
                    }

                    interventiiGlobal = data;

                    if (!data || data.length === 0) {
                        tabelBody.innerHTML = '<tr><td colspan="12" style="text-align: center;">Nu există intervenții înregistrate.</td></tr>';
                        return;
                    }

                    data.forEach(i => {
                        const id = i.ID_INTERVENTIE || i.id_interventie || i.id || i.ID;

                        // Formatăm data intervenției pentru tabel
                        const dataIntFormatata = formateazaData(i.DATA_INTERVENTIE);

                        let actionsHtml = '';
                        if (isAdmin) {
                            actionsHtml = `<div class="action-buttons"><button class="btn btn-icon" style="background:#ffc107;color:black;" onclick="deschideModalEditare(${id})"><i class="fa-solid fa-pencil"></i></button><button class="btn btn-danger btn-icon" onclick="stergeInterventie(${id})"><i class="fa-solid fa-trash"></i></button></div>`;
                        } else {
                            actionsHtml = '-';
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${id}</td>
                            <td>${i.NR_INVENTAR || '-'}</td>
                            <td>${i.TIP_ECHIPAMENT || '-'}</td>
                            <td>${dataIntFormatata}</td> <td>${i.TIP_INTERVENTIE || '-'}</td>
                            <td>${i.TIP_OPERATIE || '-'}</td>
                            <td>${i.DESCRIERE_INTERVENTIE || '-'}</td>
                            <td>${i.componente_schimbate_adaugate || '-'}</td>
                            <td>${i.DURATA_INTERVENTIE || '-'}</td>
                            <td>${i.OPERATOR || '-'}</td>
                            <td>${i.OBSERVATII || '-'}</td>
                            <td>${actionsHtml}</td>
                        `;
                        tabelBody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error(err);
                    tabelBody.innerHTML = '<tr><td colspan="12" style="color:red">Eroare rețea.</td></tr>';
                });
        }

        function stergeInterventie(id) {
            if(!confirm("Sigur dorești să ștergi această intervenție?")) return;
            fetch(`${API_BASE}/interventii/delete/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if(data.succes) { alert("Intervenție ștearsă."); incarcaInterventii(nrInventarGlobal); }
                    else { alert("Eroare: " + data.eroare); }
                });
        }

        function deschideModalEditare(id) {
            const item = interventiiGlobal.find(i => (i.ID_INTERVENTIE || i.id_interventie || i.id) == id);
            if (!item) return;

            const form = document.getElementById('form-interventie');
            form.reset();
            document.getElementById('modal-title').textContent = "Editează Intervenție";
            document.getElementById('submit-modal-btn').innerHTML = 'Actualizează';
            document.getElementById('edit-interventie-id').value = id;
            document.getElementById('modal-nr-inventar').value = item.NR_INVENTAR;
            document.getElementById('modal-tip-echip').value = item.TIP_ECHIPAMENT;

            // Setăm data în input (trebuie format YYYY-MM-DD pentru input type=date)
            if (item.DATA_INTERVENTIE) {
                try {
                    let d = new Date(item.DATA_INTERVENTIE);
                    const offset = d.getTimezoneOffset();
                    d = new Date(d.getTime() - (offset * 60 * 1000));
                    form.querySelector('[name="DATA_INTERVENTIE"]').value = d.toISOString().split('T')[0];
                } catch(e) {}
            }

            form.querySelector('[name="TIP_INTERVENTIE"]').value = item.TIP_INTERVENTIE || '';
            form.querySelector('[name="TIP_OPERATIE"]').value = item.TIP_OPERATIE || '';
            form.querySelector('[name="OPERATOR"]').value = item.OPERATOR || '';
            form.querySelector('[name="DURATA_INTERVENTIE"]').value = item.DURATA_INTERVENTIE || '';
            form.querySelector('[name="DESCRIERE_INTERVENTIE"]').value = item.DESCRIERE_INTERVENTIE || '';
            form.querySelector('[name="componente_schimbate_adaugate"]').value = item.componente_schimbate_adaugate || '';
            form.querySelector('[name="OBSERVATII"]').value = item.OBSERVATII || '';

            document.getElementById('modal-interventie').style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            nrInventarGlobal = params.get('id');
            tipArticolGlobal = params.get('type');

            if (!nrInventarGlobal || !tipArticolGlobal) return;

            await checkUser();
            incarcaDetaliiArticol(nrInventarGlobal, tipArticolGlobal);
            incarcaInterventii(nrInventarGlobal);

            document.getElementById('btn-genereaza-pdf').addEventListener('click', () => {
                window.open(`${API_BASE}/print/${encodeURIComponent(nrInventarGlobal)}`, '_blank');
            });

            document.getElementById('btn-editeaza').addEventListener('click', () => {
                window.location.href = `formular.html?type=${tipArticolGlobal}&id=${encodeURIComponent(nrInventarGlobal)}`;
            });

            document.getElementById('btn-sterge').addEventListener('click', () => {
                if(confirm('Sigur vrei să ștergi acest articol?')) {
                    fetch(`${API_BASE}/assets/delete/${encodeURIComponent(nrInventarGlobal)}`, {method: 'POST'})
                    .then(r => r.json()).then(d => {
                        if(d.succes) window.location.href = 'index.html'; else alert(d.eroare);
                    });
                }
            });

            // Modal logic...
            const modal = document.getElementById('modal-interventie');
            const form = document.getElementById('form-interventie');
            document.getElementById('btn-adauga-interventie').addEventListener('click', () => {
                form.reset();
                document.getElementById('modal-title').textContent = "Adaugă Intervenție";
                document.getElementById('edit-interventie-id').value = "";
                document.getElementById('modal-nr-inventar').value = nrInventarGlobal;
                document.querySelector('[name="DATA_INTERVENTIE"]').valueAsDate = new Date();
                modal.style.display = 'flex';
            });

            const inchide = () => modal.style.display = 'none';
            document.getElementById('close-modal-btn').onclick = inchide;
            document.getElementById('cancel-modal-btn').onclick = inchide;

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(form).entries());
                const id = document.getElementById('edit-interventie-id').value;
                const url = id ? `${API_BASE}/interventii/update/${id}` : `${API_BASE}/interventii/add`;
                const method = id ? 'PUT' : 'POST';

                fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
                .then(r=>r.json()).then(d => {
                    if(d.succes) { inchide(); incarcaInterventii(nrInventarGlobal); }
                    else alert(d.eroare);
                });
            });
        });
    </script>

</body>
</html>