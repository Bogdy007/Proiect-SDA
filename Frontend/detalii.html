<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalii Articol</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <header>
        <h1><i class="fa-solid fa-desktop"></i> Evidență Echipamente IT</h1>
    </header>

    <main class="container">

        <div class="page-actions">
             <h2 id="titlu-echipament">...</h2>
             <a href="index.html" class="btn" style="background-color: var(--secondary-color);"><i class="fa-solid fa-arrow-left"></i> Înapoi la listă</a>
        </div>

        <div class="actions">
            <button id="btn-genereaza-pdf" class="btn"><i class="fa-solid fa-file-pdf"></i> Generează Fișă (PDF)</button>
            <button id="btn-editeaza" class="btn"><i class="fa-solid fa-pencil"></i> Editează Articol</button>
            <button id="btn-sterge" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Șterge Articol</button>
        </div>

        <section class="detalii-echipament">
            <h3>Date Articol</h3>
            <div class="detalii-grid" id="info-articol">
            </div>
        </section>

        <div class="page-actions">
            <h2><i class="fa-solid fa-screwdriver-wrench"></i> Istoric Intervenții</h2>
            <button id="btn-adauga-interventie" class="btn btn-adauga"><i class="fa-solid fa-plus"></i> Adaugă Intervenție Nouă</button>
        </div>

        <section id="istoric-interventii">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tip Echip.</th>
                        <th>Tip Intervenție</th>
                        <th>Tip Operație</th>
                        <th>Descriere</th>
                        <th>Componente</th>
                        <th>Durata</th>
                        <th>Operator</th>
                        <th>Observații</th>
                    </tr>
                </thead>
                <tbody id="interventii-body">
                </tbody>
            </table>
        </section>
    </main>

    <div id="modal-interventie" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-plus-circle"></i> Adaugă Intervenție Nouă</h2>
                <span class="close-button" id="close-modal-btn">&times;</span>
            </div>

            <form id="form-interventie">
                <div class="detalii-grid">
                    <div class="form-group">
                        <label for="interv-data">Data Intervenție</label>
                        <input type="date" id="interv-data" name="DATA_INTERVENTIE" required>
                    </div>
                    <div class="form-group">
                        <label for="interv-tip-echip">Tip Echipament</label>
                        <input type="text" id="interv-tip-echip" name="TIP_ECHIPAMENT">
                    </div>
                    <div class="form-group">
                        <label for="interv-tip-interv">Tip Intervenție</label>
                        <input type="text" id="interv-tip-interv" name="TIP_INTERVENTIE" required>
                    </div>
                    <div class="form-group">
                        <label for="interv-tip-op">Tip Operație</label>
                        <input type="text" id="interv-tip-op" name="TIP_OPERATIE">
                    </div>
                    <div class="form-group">
                        <label for="interv-durata">Durata Intervenție</label>
                        <input type="text" id="interv-durata" name="DURATA_INTERVENTIE">
                    </div>
                    <div class="form-group">
                        <label for="interv-operator">Operator</label>
                        <input type="text" id="interv-operator" name="OPERATOR" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="interv-descriere">Descrierea Intervenției</label>
                    <textarea id="interv-descriere" name="DESCRIERE_INTERVENTIE" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="interv-componente">Componente Schimbate/Adăugate</label>
                    <textarea id="interv-componente" name="componente_schimbate_adaugate" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="interv-obs">Observații</label>
                    <textarea id="interv-obs" name="OBSERVATII" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" id="cancel-modal-btn" style="background-color: #6c757d;"><i class="fa-solid fa-xmark"></i> Anulează</button>
                    <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Salvează Intervenție</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="app-footer">
        <p>© 2025 Parchetul de pe lângă Tribunalul Brașov. Toate drepturile rezervate. Aplicație internă de inventariere.</p>
    </footer>


    <script>
        const API_ECHIPAMENT_URL = 'http://127.0.0.1:5000/api/echipament';
        const API_PERIFERIC_URL = 'http://127.0.0.1:5000/api/periferic';
        const API_DELETE_URL = 'http://127.0.0.1:5000/api/assets/delete';
        const API_PRINT_URL = 'http://127.0.0.1:5000/api/print';
        const API_INTERVENTII_URL = 'http://127.0.0.1:5000/api/interventii';

        let nrInventarGlobal = null;
        let tipArticolGlobal = null;

        function createDetailField(label, value) {
            return `<p><strong>${label}</strong> <span>${value || 'N/A'}</span></p>`;
        }

        function incarcaDetaliiArticol(nrInventar, tip) {
            let url = (tip === 'echipament') ? `${API_ECHIPAMENT_URL}/${nrInventar}` : `${API_PERIFERIC_URL}/${nrInventar}`;

            fetch(url)
                .then(response => response.json())
                .then(item => {
                    if (!item || item.eroare) {
                        document.getElementById('titlu-echipament').textContent = `Eroare: Articolul ${nrInventar} nu a fost găsit.`;
                        return;
                    }

                    document.getElementById('titlu-echipament').innerHTML = `<i class="fa-solid fa-barcode"></i> Detalii: ${item.NR_INVENTAR}`;
                    const container = document.getElementById('info-articol');
                    container.innerHTML = '';

                    if (tip === 'echipament') {
                        container.innerHTML += createDetailField('Nr. Inventar', item.NR_INVENTAR);
                        container.innerHTML += createDetailField('Categorie', item.CATEGORIE);
                        container.innerHTML += createDetailField('Tip Echipament', item.TIP_CALC);
                        container.innerHTML += createDetailField('Nume PC', item.NUME_PC);
                        container.innerHTML += createDetailField('Utilizator', item.UTILIZATOR);
                        container.innerHTML += createDetailField('Nr. User', item.NR_USER);
                        container.innerHTML += createDetailField('Data Achiziție', item.DATA_ACHIZITIE);
                        container.innerHTML += createDetailField('Etaj', item.ETAJ);
                        container.innerHTML += createDetailField('Funcție', item.FUNCTIE);
                        container.innerHTML += createDetailField('Adresă IP', item.IP);
                        container.innerHTML += createDetailField('Retea', item.RETEA);
                        container.innerHTML += createDetailField('Serie UC', item.SERIE_UC);
                        container.innerHTML += createDetailField('Serie Monitor', item.SERIE_MON);
                        container.innerHTML += createDetailField('Memorie', item.MEMORIE);
                        container.innerHTML += createDetailField('Sistem Operare', item.SISTEM_OPERARE);
                        container.innerHTML += createDetailField('Licență SO', item.LICENTA_SO);
                        container.innerHTML += createDetailField('Office', item.OFFICE);
                        container.innerHTML += createDetailField('Licență Office', item.LICENTA_OFFICE);
                        container.innerHTML += createDetailField('Antivirus', item.ANTIVIRUS);
                        container.innerHTML += createDetailField('Cameră', item.CAMERA);
                        container.innerHTML += createDetailField('Telefon', item.TELEFON);
                        container.innerHTML += createDetailField('Periferice Atașate', item.PERIFERICE);
                        container.innerHTML += createDetailField('Parchet', item.PARCHET);
                        container.innerHTML += createDetailField('Pass', item.PASS);
                        container.innerHTML += createDetailField('Observații', item.OBS);
                    } else if (tip === 'periferic') {
                        container.innerHTML += createDetailField('Nr. Inventar', item.NR_INVENTAR);
                        container.innerHTML += createDetailField('Categorie', item.CATEGORIE);
                        container.innerHTML += createDetailField('Tip', item.TIP);
                        container.innerHTML += createDetailField('Producător', item.PRODUCATOR);
                        container.innerHTML += createDetailField('Nume Periferic', item.NUME_PERIFERICE);
                        container.innerHTML += createDetailField('Utilizator', item.UTILIZATOR);
                        container.innerHTML += createDetailField('Nume User', item.NUME_USER);
                        container.innerHTML += createDetailField('Data Achiziție', item.DATA_ACHIZITIE);
                        container.innerHTML += createDetailField('Calculator Conectat', item.NUME_CALC);
                        container.innerHTML += createDetailField('Serie UC Conectată', item.SERIE_UC);
                        container.innerHTML += createDetailField('Adresă IP', item.IP);
                        container.innerHTML += createDetailField('Retea', item.RETEA);
                        container.innerHTML += createDetailField('Memorie', item.MEMORIE);
                        container.innerHTML += createDetailField('Format', item.FORMAT);
                        container.innerHTML += createDetailField('Culoare Imprimare', item.CULOARE_IMPRIMARE);
                        container.innerHTML += createDetailField('Duplex', item.DUPLEX);
                        container.innerHTML += createDetailField('Stare Parametri', item.STARE_PARAMETRI);
                        container.innerHTML += createDetailField('Cameră', item.CAMERA);
                        container.innerHTML += createDetailField('Antivirus', item.ANTIVIRUS);
                        container.innerHTML += createDetailField('Parchet', item.PARCHET);
                        container.innerHTML += createDetailField('Pass', item.PASS);
                        container.innerHTML += createDetailField('Observații', item.OBS);
                        container.innerHTML += createDetailField('Observații 2', item.OBS2);
                    }
                })
                .catch(error => console.error('Eroare detalii:', error));
        }

        function incarcaInterventii(nrInventar) {
            const tabelBody = document.getElementById('interventii-body');
            tabelBody.innerHTML = '<tr><td colspan="9">Se încarcă...</td></tr>';

            fetch(`${API_INTERVENTII_URL}/${nrInventar}`)
                .then(response => response.json())
                .then(data => {
                    tabelBody.innerHTML = '';
                    if (data.eroare) {
                        throw new Error(data.eroare);
                    }
                    if (data.length === 0) {
                        tabelBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nu există intervenții înregistrate.</td></tr>';
                        return;
                    }

                    data.forEach(interventie => {
                        const rand = document.createElement('tr');
                        rand.innerHTML = `
                            <td>${interventie.DATA_INTERVENTIE || 'N/A'}</td>
                            <td>${interventie.TIP_ECHIPAMENT || 'N/A'}</td>
                            <td>${interventie.TIP_INTERVENTIE || 'N/A'}</td>
                            <td>${interventie.TIP_OPERATIE || 'N/A'}</td>
                            <td>${interventie.DESCRIERE_INTERVENTIE || 'N/A'}</td>
                            <td>${interventie.componente_schimbate_adaugate || 'N/A'}</td>
                            <td>${interventie.DURATA_INTERVENTIE || 'N/A'}</td>
                            <td>${interventie.OPERATOR || 'N/A'}</td>
                            <td>${interventie.OBSERVATII || 'N/A'}</td>
                        `;
                        tabelBody.appendChild(rand);
                    });
                })
                .catch(error => {
                    console.error('Eroare la încărcarea intervențiilor:', error);
                    tabelBody.innerHTML = `<tr><td colspan="9" style="text-align: center;">Eroare la încărcarea intervențiilor.</td></tr>`;
                });
        }

        function inchideModal(modal) {
            modal.classList.add('fade-out');
            modal.addEventListener('animationend', function handler() {
                modal.style.display = 'none';
                modal.classList.remove('fade-out');
                modal.removeEventListener('animationend', handler);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const nrInventar = params.get('id');
            const tipArticol = params.get('type');

            if (nrInventar && tipArticol) {
                nrInventarGlobal = nrInventar;
                tipArticolGlobal = tipArticol;

                incarcaDetaliiArticol(nrInventar, tipArticol);
                incarcaInterventii(nrInventar);

                document.getElementById('btn-genereaza-pdf').addEventListener('click', () => {
                    window.open(`${API_PRINT_URL}/${nrInventar}`, '_blank');
                });

                document.getElementById('btn-editeaza').addEventListener('click', () => {
                    alert('Funcția de editare nu este încă implementată în acest demo.');
                    // TODO: Vei avea nevoie de un formular de editare similar cu cel de adăugare
                    // window.location.href = `formular.html?id=${nrInventar}&type=${tipArticol}`;
                });

                document.getElementById('btn-sterge').addEventListener('click', () => {
                    if (confirm(`Ești sigur că vrei să ștergi articolul ${nrInventar}? Această acțiune este permanentă și va șterge și intervențiile asociate.`)) {
                        fetch(`${API_DELETE_URL}/${nrInventar}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.succes) {
                                alert(data.mesaj || 'Articol șters!');
                                window.location.href = 'index.html';
                            } else {
                                alert('Eroare la ștergere: ' + (data.eroare || 'Eroare'));
                            }
                        })
                        .catch(error => alert('Eroare de rețea. Serverul nu a putut fi contactat.'));
                    }
                });

                const modal = document.getElementById('modal-interventie');
                const btnAdauga = document.getElementById('btn-adauga-interventie');
                const btnInchide = document.getElementById('close-modal-btn');
                const btnAnuleaza = document.getElementById('cancel-modal-btn');
                const formInterventie = document.getElementById('form-interventie');

                btnAdauga.addEventListener('click', () => {
                    formInterventie.reset();
                    document.getElementById('interv-tip-echip').value = tipArticolGlobal;
                    modal.classList.remove('fade-out');
                    modal.style.display = 'flex';
                });

                btnInchide.addEventListener('click', () => {
                    inchideModal(modal);
                });

                btnAnuleaza.addEventListener('click', () => {
                    inchideModal(modal);
                });

                formInterventie.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const formData = new FormData(formInterventie);
                    const dataObject = Object.fromEntries(formData.entries());
                    dataObject.NR_INVENTAR = nrInventarGlobal;

                    fetch(`${API_INTERVENTII_URL}/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataObject)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.succes) {
                            alert('Intervenție adăugată cu succes!');
                            inchideModal(modal);
                            incarcaInterventii(nrInventarGlobal);
                        } else {
                            alert('Eroare la salvare: ' + (data.eroare || 'Eroare necunoscută'));
                        }
                    })
                    .catch(error => {
                        console.error('Eroare de rețea:', error);
                        alert('Eroare de rețea. Serverul nu a putut fi contactat.');
                    });
                });

            } else {
                document.getElementById('titlu-echipament').textContent = "Eroare: Articol sau tip invalid.";
                document.querySelector('.container').innerHTML = '<h2>Vă rugăm selectați un articol din <a href="index.html">lista principală</a>.</h2>';
            }
        });
    </script>
</body>
</html>