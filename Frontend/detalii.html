<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalii Articol</title>
    <link rel="icon" type="image/png" href="images/logo_intro.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .table-scroll-container {
            overflow-x: auto;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        #istoric-interventii table {
            min-width: 1000px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-icon {
            padding: 5px 8px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <header>
        <h1>
            <img src="images/logo_intro.png" alt="Logo" class="header-logo">
            Evidență Echipamente IT
        </h1>
    </header>

    <main class="container">

        <div class="page-actions">
             <h2 id="titlu-echipament">Se încarcă datele...</h2>
             <a href="index.html" class="btn" style="background-color: var(--secondary-color);"><i class="fa-solid fa-arrow-left"></i> Înapoi la listă</a>
        </div>

        <div class="actions">
            <button id="btn-genereaza-pdf" class="btn"><i class="fa-solid fa-file-pdf"></i> Generează Fișă (PDF)</button>
            <button id="btn-editeaza" class="btn" style="background-color: #ffc107; color: #000 !important;"><i class="fa-solid fa-pencil"></i> Editează Articol</button>
            <button id="btn-sterge" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Șterge Articol</button>
        </div>

        <section class="detalii-echipament">
            <h3><i class="fa-solid fa-circle-info"></i> Date Articol</h3>
            <div class="detalii-grid" id="info-articol">
            </div>
        </section>

        <div class="page-actions" style="margin-top: 40px;">
            <h2><i class="fa-solid fa-screwdriver-wrench"></i> Istoric Intervenții</h2>
            <button id="btn-adauga-interventie" class="btn btn-adauga"><i class="fa-solid fa-plus"></i> Adaugă Intervenție</button>
        </div>

        <section id="istoric-interventii">
            <div class="table-scroll-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nr. Inv</th>
                            <th>Tip Echip.</th>
                            <th>Data</th>
                            <th>Tip Int.</th>
                            <th>Operație</th>
                            <th>Descriere</th>
                            <th>Componente</th>
                            <th>Durată</th>
                            <th>Operator</th>
                            <th>Observații</th>
                            <th>Acțiuni</th>
                        </tr>
                    </thead>
                    <tbody id="interventii-body">
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-interventie" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Adaugă Intervenție Nouă</h2>
                <span class="close-button" id="close-modal-btn">&times;</span>
            </div>

            <form id="form-interventie">
                <input type="hidden" id="edit-interventie-id" value="">

                <div class="detalii-grid">
                    <div class="form-group">
                        <label>Nr. Inventar</label>
                        <input type="text" id="modal-nr-inventar" name="NR_INVENTAR" required>
                    </div>

                    <div class="form-group">
                        <label>Data Intervenție</label>
                        <input type="date" name="DATA_INTERVENTIE" required>
                    </div>
                    <div class="form-group">
                        <label>Tip Intervenție (Software/Hardware)</label>
                        <input type="text" name="TIP_INTERVENTIE" list="list-tipuri">
                        <datalist id="list-tipuri">
                            <option value="Hardware">
                            <option value="Software">
                            <option value="Mentenanță">
                            <option value="Instalare">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label>Tip Operație (ex: Înlocuire)</label>
                        <input type="text" name="TIP_OPERATIE">
                    </div>
                    <div class="form-group">
                        <label>Operator</label>
                        <input type="text" name="OPERATOR" required>
                    </div>
                    <div class="form-group">
                        <label>Durata</label>
                        <input type="text" name="DURATA_INTERVENTIE" placeholder="ex: 30 min">
                    </div>
                </div>

                <div class="form-group">
                    <label>Descriere Detaliată</label>
                    <textarea name="DESCRIERE_INTERVENTIE" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Componente Schimbate / Adăugate</label>
                    <textarea name="componente_schimbate_adaugate" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Observații</label>
                    <textarea name="OBSERVATII" rows="2"></textarea>
                </div>

                <input type="hidden" id="modal-tip-echip" name="TIP_ECHIPAMENT">

                <div class="form-actions">
                    <button type="button" class="btn" id="cancel-modal-btn" style="background-color: #6c757d;">Anulează</button>
                    <button type="submit" class="btn" id="submit-modal-btn">Salvează</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="app-footer">
        <p>© 2025 Aplicație de Inventariere IT</p>
    </footer>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';

        let nrInventarGlobal = null;
        let tipArticolGlobal = null;
        let interventiiGlobal = [];

        function createDetailField(label, value) {
            const valStr = (value && value !== 'None' && value !== 'null') ? value : '-';
            return `<p><strong>${label}</strong> <span>${valStr}</span></p>`;
        }

        function incarcaDetaliiArticol(nrInventar, tip) {
            let url = (tip === 'echipament')
                ? `${API_BASE}/echipament/${nrInventar}`
                : `${API_BASE}/periferic/${nrInventar}`;

            fetch(url)
                .then(response => response.json())
                .then(item => {
                    if (!item || item.eroare) {
                        document.getElementById('titlu-echipament').textContent = `Eroare: Articolul nu a fost găsit.`;
                        return;
                    }

                    document.getElementById('titlu-echipament').innerHTML =
                        `<i class="fa-solid fa-barcode"></i> ${item.NR_INVENTAR} <small style="font-size:0.6em; color:#666;">(${item.CATEGORIE})</small>`;

                    const container = document.getElementById('info-articol');
                    container.innerHTML = '';

                    if (tip === 'echipament') {
                        container.innerHTML += createDetailField('Nr. Inventar', item.NR_INVENTAR);
                        container.innerHTML += createDetailField('Tip Echipament', item.TIP_CALC);
                        container.innerHTML += createDetailField('Nume PC', item.NUME_PC);
                        container.innerHTML += createDetailField('Utilizator', item.UTILIZATOR);
                        container.innerHTML += createDetailField('Nr. User', item.NR_USER);
                        container.innerHTML += createDetailField('Data Achiziție', item.DATA_ACHIZITIE);
                        container.innerHTML += createDetailField('Etaj', item.ETAJ);
                        container.innerHTML += createDetailField('Funcție', item.FUNCTIE);
                        container.innerHTML += createDetailField('Parchet', item.PARCHET);
                        container.innerHTML += createDetailField('Adresă IP', item.IP);
                        container.innerHTML += createDetailField('Rețea', item.RETEA);
                        container.innerHTML += createDetailField('Serie UC', item.SERIE_UC);
                        container.innerHTML += createDetailField('Serie Monitor', item.SERIE_MON);
                        container.innerHTML += createDetailField('Memorie/Specificații', item.MEMORIE);
                        container.innerHTML += createDetailField('Sistem Operare', item.SISTEM_OPERARE);
                        container.innerHTML += createDetailField('Licență SO', item.LICENTA_SO);
                        container.innerHTML += createDetailField('Office', item.OFFICE);
                        container.innerHTML += createDetailField('Licență Office', item.LICENTA_OFFICE);
                        container.innerHTML += createDetailField('Antivirus', item.ANTIVIRUS);
                        container.innerHTML += createDetailField('Cameră', item.CAMERA);
                        container.innerHTML += createDetailField('Telefon', item.TELEFON);
                        container.innerHTML += createDetailField('Pass', item.PASS);
                        container.innerHTML += createDetailField('Periferice Atașate', item.PERIFERICE);
                        container.innerHTML += createDetailField('Observații', item.OBS);
                    } else {
                        container.innerHTML += createDetailField('Nr. Inventar', item.NR_INVENTAR);
                        container.innerHTML += createDetailField('Tip', item.TIP);
                        container.innerHTML += createDetailField('Producător', item.PRODUCATOR);
                        container.innerHTML += createDetailField('Model / Nume', item.NUME_PERIFERICE);
                        container.innerHTML += createDetailField('Utilizator', item.UTILIZATOR);
                        container.innerHTML += createDetailField('Nume User', item.NUME_USER);
                        container.innerHTML += createDetailField('Data Achiziție', item.DATA_ACHIZITIE);
                        container.innerHTML += createDetailField('Conectat la PC', item.NUME_CALC);
                        container.innerHTML += createDetailField('Serie UC', item.SERIE_UC);
                        container.innerHTML += createDetailField('Adresă IP', item.IP);
                        container.innerHTML += createDetailField('Rețea', item.RETEA);
                        container.innerHTML += createDetailField('Memorie', item.MEMORIE);
                        container.innerHTML += createDetailField('Format', item.FORMAT);
                        container.innerHTML += createDetailField('Culoare', item.CULOARE_IMPRIMARE);
                        container.innerHTML += createDetailField('Duplex', item.DUPLEX);
                        container.innerHTML += createDetailField('Stare', item.STARE_PARAMETRI);
                        container.innerHTML += createDetailField('Cameră', item.CAMERA);
                        container.innerHTML += createDetailField('Antivirus', item.ANTIVIRUS);
                        container.innerHTML += createDetailField('Parchet', item.PARCHET);
                        container.innerHTML += createDetailField('Pass', item.PASS);
                        container.innerHTML += createDetailField('Observații', item.OBS);
                        container.innerHTML += createDetailField('Observații 2', item.OBS2);
                    }
                })
                .catch(error => {
                    console.error('Eroare detalii:', error);
                    document.getElementById('info-articol').innerHTML = '<p style="color:red">Eroare la conectarea cu serverul.</p>';
                });
        }

        function incarcaInterventii(nrInventar) {
            const tabelBody = document.getElementById('interventii-body');
            tabelBody.innerHTML = '<tr><td colspan="12">Se încarcă istoricul...</td></tr>';

            fetch(`${API_BASE}/interventii/${nrInventar}`)
                .then(response => response.json())
                .then(data => {
                    tabelBody.innerHTML = '';

                    if (data.eroare) {
                         tabelBody.innerHTML = `<tr><td colspan="12" style="color:red">Eroare: ${data.eroare}</td></tr>`;
                         return;
                    }

                    interventiiGlobal = data;

                    if (!data || data.length === 0) {
                        tabelBody.innerHTML = '<tr><td colspan="12" style="text-align: center;">Nu există intervenții înregistrate.</td></tr>';
                        return;
                    }

                    data.forEach(i => {
                        const id = i.ID_INTERVENTIE || i.id_interventie || i.id || i.ID;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${id}</td>
                            <td>${i.NR_INVENTAR || '-'}</td>
                            <td>${i.TIP_ECHIPAMENT || '-'}</td>
                            <td>${i.DATA_INTERVENTIE || '-'}</td>
                            <td>${i.TIP_INTERVENTIE || '-'}</td>
                            <td>${i.TIP_OPERATIE || '-'}</td>
                            <td>${i.DESCRIERE_INTERVENTIE || '-'}</td>
                            <td>${i.componente_schimbate_adaugate || '-'}</td>
                            <td>${i.DURATA_INTERVENTIE || '-'}</td>
                            <td>${i.OPERATOR || '-'}</td>
                            <td>${i.OBSERVATII || '-'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-icon" style="background-color: #ffc107; color:black;" onclick="deschideModalEditare(${id})">
                                        <i class="fa-solid fa-pencil"></i>
                                    </button>
                                    <button class="btn btn-danger btn-icon" onclick="stergeInterventie(${id})">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tabelBody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error(err);
                    tabelBody.innerHTML = '<tr><td colspan="12" style="color:red">Eroare rețea.</td></tr>';
                });
        }

        function stergeInterventie(id) {
            if(!confirm("Sigur dorești să ștergi această intervenție?")) return;

            fetch(`${API_BASE}/interventii/delete/${id}`, { method: 'POST' })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.eroare || res.statusText);
                    return data;
                })
                .then(data => {
                    if(data.succes) {
                        alert("Intervenție ștearsă.");
                        incarcaInterventii(nrInventarGlobal);
                    } else {
                        alert("Eroare: " + data.eroare);
                    }
                })
                .catch(err => alert("Eroare rețea: " + err.message));
        }

        function deschideModalEditare(id) {
            const interventie = interventiiGlobal.find(i => {
                const itemId = i.ID_INTERVENTIE || i.id_interventie || i.id || i.ID;
                return itemId == id;
            });

            if (!interventie) {
                alert("Eroare: Nu s-au putut încărca datele intervenției.");
                return;
            }

            const form = document.getElementById('form-interventie');
            form.reset();

            document.getElementById('modal-title').textContent = "Editează Intervenție";
            document.getElementById('submit-modal-btn').innerHTML = '<i class="fa-solid fa-save"></i> Actualizează';
            document.getElementById('edit-interventie-id').value = id;

            document.getElementById('modal-nr-inventar').value = interventie.NR_INVENTAR;
            document.getElementById('modal-tip-echip').value = interventie.TIP_ECHIPAMENT;

            if (interventie.DATA_INTERVENTIE) {
                try {
                    let d = new Date(interventie.DATA_INTERVENTIE);
                    const offset = d.getTimezoneOffset();
                    d = new Date(d.getTime() - (offset*60*1000));
                    form.querySelector('[name="DATA_INTERVENTIE"]').value = d.toISOString().split('T')[0];
                } catch(e) { }
            }

            form.querySelector('[name="TIP_INTERVENTIE"]').value = interventie.TIP_INTERVENTIE || '';
            form.querySelector('[name="TIP_OPERATIE"]').value = interventie.TIP_OPERATIE || '';
            form.querySelector('[name="OPERATOR"]').value = interventie.OPERATOR || '';
            form.querySelector('[name="DURATA_INTERVENTIE"]').value = interventie.DURATA_INTERVENTIE || '';
            form.querySelector('[name="DESCRIERE_INTERVENTIE"]').value = interventie.DESCRIERE_INTERVENTIE || '';
            form.querySelector('[name="componente_schimbate_adaugate"]').value = interventie.componente_schimbate_adaugate || '';
            form.querySelector('[name="OBSERVATII"]').value = interventie.OBSERVATII || '';

            document.getElementById('modal-interventie').style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            nrInventarGlobal = params.get('id');
            tipArticolGlobal = params.get('type');

            if (!nrInventarGlobal || !tipArticolGlobal) {
                document.getElementById('titlu-echipament').textContent = "Eroare: Lipsesc parametrii (id sau type).";
                document.querySelector('.actions').style.display = 'none';
                return;
            }

            incarcaDetaliiArticol(nrInventarGlobal, tipArticolGlobal);
            incarcaInterventii(nrInventarGlobal);

            document.getElementById('btn-genereaza-pdf').addEventListener('click', () => {
                window.open(`${API_BASE}/print/${nrInventarGlobal}`, '_blank');
            });

            document.getElementById('btn-editeaza').addEventListener('click', () => {
                window.location.href = `formular.html?type=${tipArticolGlobal}&id=${nrInventarGlobal}`;
            });

            document.getElementById('btn-sterge').addEventListener('click', () => {
                if(confirm('Sigur vrei să ștergi acest articol? Acțiunea este ireversibilă!')) {
                    fetch(`${API_BASE}/assets/delete/${nrInventarGlobal}`, {method: 'POST'})
                    .then(res => res.json())
                    .then(data => {
                        if(data.succes) {
                            alert('Articol șters cu succes.');
                            window.location.href = 'index.html';
                        } else {
                            alert('Eroare la ștergere: ' + (data.eroare || 'Necunoscută'));
                        }
                    })
                    .catch(err => alert('Eroare de conexiune.'));
                }
            });

            const modal = document.getElementById('modal-interventie');
            const formInterventie = document.getElementById('form-interventie');

            document.getElementById('btn-adauga-interventie').addEventListener('click', () => {
                formInterventie.reset();

                document.getElementById('modal-title').textContent = "Adaugă Intervenție Nouă";
                document.getElementById('submit-modal-btn').innerHTML = 'Salvează';
                document.getElementById('edit-interventie-id').value = "";

                formInterventie.querySelector('[name="DATA_INTERVENTIE"]').valueAsDate = new Date();

                document.getElementById('modal-nr-inventar').value = nrInventarGlobal;
                document.getElementById('modal-tip-echip').value = tipArticolGlobal;
                modal.style.display = 'flex';
            });

            const inchideModal = () => { modal.style.display = 'none'; };
            document.getElementById('close-modal-btn').addEventListener('click', inchideModal);
            document.getElementById('cancel-modal-btn').addEventListener('click', inchideModal);
            window.onclick = (event) => { if (event.target == modal) inchideModal(); };

            formInterventie.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(formInterventie);
                const dataObj = Object.fromEntries(formData.entries());
                const editId = document.getElementById('edit-interventie-id').value;

                let url = `${API_BASE}/interventii/add`;
                let method = 'POST';

                if (editId && editId !== "") {
                    url = `${API_BASE}/interventii/update/${editId}`;
                    method = 'PUT';
                }

                fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dataObj)
                })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.eroare || `Eroare server: ${res.status}`);
                    }
                    return data;
                })
                .then(data => {
                    if(data.succes) {
                        alert('Operațiune reușită!');
                        inchideModal();
                        incarcaInterventii(nrInventarGlobal);
                    } else {
                        alert('Eroare: ' + data.eroare);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Eroare: ' + err.message);
                });
            });
        });
    </script>

</body>
</html>